<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secure Motion Assistant</title>
  <style>
    body {
      background: black;
      color: lime;
      font-family: monospace;
      padding: 20px;
    }
    #console {
      background: #111;
      padding: 15px;
      min-height: 300px;
      border-radius: 10px;
      white-space: pre-wrap;
      font-size: 18px;
    }
    input, button {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 999;
      color: white;
      text-align: center;
      padding-top: 100px;
    }
    #overlay-content {
      background: #300;
      border: 2px solid red;
      padding: 30px;
      border-radius: 15px;
      display: inline-block;
    }
    #overlay input {
      padding: 10px;
      width: 200px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>üîê Secure Motion Assistant</h1>
  <button onclick="startInteraction()">üëã Simulate Motion Detected</button>
  <div id="console"></div>

  <div id="input-area" style="display:none;">
    <input id="user-input" placeholder="Type your response..." onkeydown="if(event.key==='Enter'){handleInput()}" />
    <button onclick="handleInput()">Submit</button>
  </div>

  <div id="overlay">
    <div id="overlay-content">
      <h2>üö® Terminal Locked</h2>
      <p>This message has been flagged as inappropriate and blocked.</p>
      <p>Access restricted. Enter unlock code:</p>
      <input id="unlock-code" type="text" placeholder="Enter code" onkeydown="if(event.key==='Enter'){submitUnlock()}" />
      <br><br>
      <button onclick="submitUnlock()">Unlock</button>
    </div>
    <audio id="siren" src="https://www.soundjay.com/misc/sounds/siren-noise-01.mp3" autoplay loop></audio>
  </div>

  <script>
    const consoleEl = document.getElementById('console');
    const inputArea = document.getElementById('input-area');
    const userInput = document.getElementById('user-input');
    const overlay = document.getElementById('overlay');
    const unlockInput = document.getElementById('unlock-code');
    const sirenAudio = document.getElementById('siren');

    let currentState = null;
    let userName = '';
    let asked = new Set();
    let chatMessages = [];
    let chatCount = 0;
    let locked = false;

    const UNLOCK_CODE = '2026';

    const speak = async (text) => {
      consoleEl.innerHTML += `ü§ñ: ${text}\n`;
      consoleEl.scrollTop = consoleEl.scrollHeight;
      return new Promise(resolve => {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'en-US';
        utter.onend = resolve;
        speechSynthesis.speak(utter);
      });
    };

    const listen = (state) => {
      currentState = state;
      inputArea.style.display = 'block';
      userInput.value = '';
      userInput.focus();
    };

    const startInteraction = async () => {
      if (locked) return;
      consoleEl.innerHTML = '';
      asked.clear();
      chatMessages = [];
      chatCount = 0;
      await speak("Hello! I see someone just arrived.");
      await speak("Welcome to my interactive assistant.");
      showMenu();
    };

    const showMenu = async () => {
      const options = [
        "1. What is your name?",
        "2. How are you?",
        "3. Try a math trick",
        "4. Ask anything (ChatGPT mode)",
        "5. Tell me a joke",
        "6. Fun fact of the day",
        "7. Guess my age",
        "8. Compliment me",
        "9. Surprise me",
        "10. Exit"
      ];
      await speak("Please choose one of the following options:");
      for (const line of options) {
        await speak(line);
      }
      listen("menu");
    };

    const handleInput = async () => {
      const input = userInput.value.trim().toLowerCase();
      consoleEl.innerHTML += `You: ${input}\n`;
      inputArea.style.display = 'none';

      if (locked && currentState === "unlock") {
        if (input === UNLOCK_CODE) {
          overlay.style.display = 'none';
          sirenAudio.pause();
          locked = false;
          await speak("‚úÖ Terminal unlocked.");
          startInteraction();
        } else {
          await speak("‚ùå Invalid unlock code.");
          listen("unlock");
        }
        return;
      }

      if (await containsProfanity(input)) {
        triggerLockdown(input);
        return;
      }

      if (currentState === "menu") {
        switch (input) {
          case "1":
            await speak("What is your name?");
            listen("getName"); break;
          case "2":
            await speak("How are you feeling today?");
            listen("getMood"); break;
          case "3":
            await mathTrick();
            showMenu(); break;
          case "4":
            await speak("Ask anything. You have 5 questions.");
            chatMessages = [{ role: "system", content: "You are a helpful assistant." }];
            chatCount = 0;
            listen("chatMode"); break;
          case "5":
            await speak("Why don‚Äôt skeletons fight each other? They don‚Äôt have the guts.");
            showMenu(); break;
          case "6":
            await speak("Did you know? Honey never spoils. Archaeologists have found 3000-year-old honey that‚Äôs still edible!");
            showMenu(); break;
          case "7":
            await speak("Hmm... I‚Äôd guess you're 21! üòÑ");
            showMenu(); break;
          case "8":
            await speak("You‚Äôre doing great and I‚Äôm glad you're here!");
            showMenu(); break;
          case "9":
            await speak("Surprise! You just earned a virtual high five ‚úã");
            showMenu(); break;
          case "10":
            await speak("Goodbye! Restarting soon...");
            setTimeout(startInteraction, 4000);
            break;
          default:
            await speak("Invalid option. Try again.");
            showMenu();
        }
      }

      else if (currentState === "getName") {
        userName = input.replace(/[^a-zA-Z ]/g, '');
        await speak(`Nice to meet you, ${userName || "friend"}!`);
        showMenu();
      }

      else if (currentState === "getMood") {
        await speak("Thanks for sharing that.");
        showMenu();
      }

      else if (currentState === "chatMode") {
        chatMessages.push({ role: "user", content: input });
        const reply = await fetchChat(chatMessages);
        chatMessages.push({ role: "assistant", content: reply });
        await speak(reply);
        chatCount++;
        if (chatCount >= 5) {
          await speak("That was your last question. Returning to menu...");
          showMenu();
        } else {
          listen("chatMode");
        }
      }
    };

    const mathTrick = async () => {
      await speak("Let's do a fun mind trick.");
      await speak("Think of a number. Double it. Add 10. Divide by 2. Subtract the original number.");
      await speak("The answer is... 5! üòÑ");
    };

    const triggerLockdown = async (badInput) => {
      locked = true;
      overlay.style.display = "block";
      await speak("‚ö†Ô∏è This message has been flagged as inappropriate.");
      await speak("Access has been restricted. Enter unlock code.");
      unlockInput.focus();
    };

    const submitUnlock = () => {
      handleInput();
    };

    const containsProfanity = async (text) => {
      try {
        const res = await fetch('/api/moderate', {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input: text })
        });
        const data = await res.json();
        return data.flagged === true;
      } catch (e) {
        console.warn("Moderation check failed:", e);
        return false;
      }
    };

    const fetchChat = async (messages) => {
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages })
        });
        const data = await res.json();
        return data.reply || "I couldn't get a reply.";
      } catch (e) {
        return "Error contacting the assistant.";
      }
    };

    window.startInteraction = startInteraction;
    window.handleInput = handleInput;
    window.submitUnlock = submitUnlock;
  </script>
</body>
</html>

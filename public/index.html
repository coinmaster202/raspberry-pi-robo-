<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>🔐 Secure Motion Assistant</title>
  <style>
    body {
      background: black;
      color: lime;
      font-family: monospace;
      padding: 20px;
    }
    #console {
      background: #111;
      padding: 20px;
      border-radius: 10px;
      white-space: pre-wrap;
      margin-bottom: 10px;
    }
    #input-area input, button {
      font-size: 16px;
      padding: 10px;
    }
    #input-area {
      margin-top: 10px;
    }
    h1 {
      color: lime;
    }
  </style>
</head>
<body>
  <h1>🔐 Secure Motion Assistant</h1>
  <button onclick="startInteraction()">👋 Simulate Motion Detected</button>
  <div id="console"></div>

  <div id="input-area" style="display:none;">
    <input id="user-input" placeholder="Type your response..." onkeydown="if(event.key==='Enter'){handleInput()}" />
    <button onclick="handleInput()">Submit</button>
  </div>

  <script>
    const consoleEl = document.getElementById('console');
    const inputArea = document.getElementById('input-area');
    const userInput = document.getElementById('user-input');

    let currentState = null;
    let asked = new Set();
    let chatMessages = [];
    let chatCount = 0;

    const options = [
      { key: "1", text: "What is your name?", state: "getName" },
      { key: "2", text: "How are you?", state: "getMood" },
      { key: "3", text: "Try a math trick", state: "mathTrick" },
      { key: "4", text: "Ask anything (ChatGPT mode)", state: "chatMode" },
      { key: "5", text: "Tell me a joke", state: "joke" },
      { key: "6", text: "Fun fact of the day", state: "fact" },
      { key: "7", text: "Guess my age", state: "guessAge" },
      { key: "8", text: "Compliment me", state: "compliment" },
      { key: "9", text: "Surprise me", state: "surprise" },
      { key: "10", text: "Exit", state: "exit" }
    ];

    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'en-US';
      msg.rate = 1;
      speechSynthesis.speak(msg);
      consoleEl.innerHTML += `🤖: ${text}\n`;
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    function listen(state) {
      currentState = state;
      inputArea.style.display = 'block';
      userInput.value = '';
      userInput.focus();
    }

    async function startInteraction() {
      consoleEl.innerHTML = "";
      asked.clear();
      chatMessages = [];
      chatCount = 0;
      speak("Hello! I see someone just arrived.");
      await showMenu();
    }

    async function showMenu() {
      speak("Please choose one of the following options:");
      for (const opt of options) {
        if (!asked.has(opt.key)) {
          speak(`${opt.key}. ${opt.text}`);
        }
      }
      listen("menu");
    }

    async function handleInput() {
      const raw = userInput.value.trim();
      const input = raw.toLowerCase();
      inputArea.style.display = 'none';
      consoleEl.innerHTML += `You: ${raw}\n`;

      if (currentState === "menu") {
        const selected = options.find(opt => opt.key === input);
        if (!selected || asked.has(selected.key)) {
          speak("That option is not available or already used.");
          return showMenu();
        }

        asked.add(selected.key);
        if (selected.state === "getName") {
          speak("What is your name?");
          listen("getName");
        } else if (selected.state === "getMood") {
          speak("How are you feeling today?");
          listen("getMood");
        } else if (selected.state === "mathTrick") {
          await mathTrick(); showMenu();
        } else if (selected.state === "chatMode") {
          chatMessages = [{ role: "system", content: "You are a helpful assistant." }];
          chatCount = 0;
          speak("Ask anything. You have 5 questions.");
          listen("chatMode");
        } else if (selected.state === "joke") {
          speak("Why did the scarecrow win an award? Because he was outstanding in his field!");
          showMenu();
        } else if (selected.state === "fact") {
          speak("Did you know honey never spoils? Archaeologists found 3,000-year-old honey in Egyptian tombs that's still edible.");
          showMenu();
        } else if (selected.state === "guessAge") {
          speak("Hmm... I'm guessing you're 21. Just a lucky guess!");
          showMenu();
        } else if (selected.state === "compliment") {
          speak("You're doing amazing. Keep it up!");
          showMenu();
        } else if (selected.state === "surprise") {
          speak("🎉 You just unlocked a secret! Surprise!");
          showMenu();
        } else if (selected.state === "exit") {
          speak("Goodbye! Restarting soon...");
          setTimeout(startInteraction, 5000);
        }
      }

      else if (currentState === "getName") {
        speak(`Nice to meet you, ${raw}!`);
        showMenu();
      }

      else if (currentState === "getMood") {
        speak(`Thanks for sharing that with me.`);
        showMenu();
      }

      else if (currentState === "chatMode") {
        chatMessages.push({ role: "user", content: raw });

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messages: chatMessages })
          });
          const data = await response.json();
          const reply = data.reply || "⚠️ Assistant failed to reply.";
          chatMessages.push({ role: "assistant", content: reply });
          speak(reply);
        } catch (e) {
          console.error(e);
          speak("Sorry, I couldn't connect to the assistant.");
        }

        chatCount++;
        if (chatCount >= 5) {
          speak("That was your last question. Returning to menu...");
          showMenu();
        } else {
          listen("chatMode");
        }
      }
    }

    async function mathTrick() {
      speak("Let's do a fun mind trick.");
      await delay(1000);
      speak("Think of any number.");
      await delay(1300);
      speak("Double it.");
      await delay(1300);
      speak("Add 10.");
      await delay(1300);
      speak("Divide by 2.");
      await delay(1300);
      speak("Now subtract the number you started with.");
      await delay(1300);
      speak("The answer is... 5!");
    }

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    window.startInteraction = startInteraction;
    window.handleInput = handleInput;
  </script>
</body>
</html>

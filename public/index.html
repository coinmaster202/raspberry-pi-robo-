<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🔐 Secure Motion Assistant</title>
  <style>
    body {
      background: #000;
      color: lime;
      font-family: monospace;
      padding: 20px;
    }
    #console {
      background: #111;
      padding: 20px;
      border-radius: 10px;
      white-space: pre-wrap;
      min-height: 300px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
    }
    #input-area {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>🔐 Secure Motion Assistant</h1>
  <button onclick="start()">👋 Simulate Motion Detected</button>
  <div id="console"></div>
  <div id="input-area" style="display:none;">
    <input id="user-input" placeholder="Type your response..." />
    <button onclick="handle()">Submit</button>
  </div>

  <script>
    const consoleEl = document.getElementById("console");
    const inputArea = document.getElementById("input-area");
    const userInput = document.getElementById("user-input");

    let state = null;
    let chatMessages = [];
    let chatCount = 0;

    const OPTIONS = [
      { key: "1", text: "What is your name?", state: "getName" },
      { key: "2", text: "How are you?", state: "getMood" },
      { key: "3", text: "Try a math trick", state: "mathTrick" },
      { key: "4", text: "Ask anything (ChatGPT mode)", state: "chat" },
      { key: "5", text: "Tell me a joke", prompt: "Tell me a funny joke." },
      { key: "6", text: "Fun fact of the day", prompt: "Tell me a fun fact." },
      { key: "7", text: "Guess my age", prompt: "Try to guess how old I am." },
      { key: "8", text: "Compliment me", prompt: "Say something nice to me." },
      { key: "9", text: "Surprise me", prompt: "Give me a random surprise." },
      { key: "10", text: "Exit", state: "exit" }
    ];

    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'en-US';
      msg.rate = 1;
      speechSynthesis.speak(msg);
      consoleEl.innerHTML += `🤖: ${text}\n`;
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    function listen(nextState) {
      state = nextState;
      inputArea.style.display = "block";
      userInput.focus();
    }

    function start() {
      consoleEl.innerHTML = "";
      chatMessages = [];
      chatCount = 0;
      speak("Hello! I see someone just arrived.");
      setTimeout(showMenu, 1000);
    }

    function showMenu() {
      speak("Please choose one of the following options:");
      OPTIONS.forEach(opt => speak(`${opt.key}. ${opt.text}`));
      listen("menu");
    }

    async function handle() {
      const input = userInput.value.trim();
      inputArea.style.display = "none";
      consoleEl.innerHTML += `You: ${input}\n`;

      if (state === "menu") {
        const choice = OPTIONS.find(opt => opt.key === input);
        if (!choice) {
          speak("That option is not available.");
          return showMenu();
        }

        if (choice.prompt) {
          const reply = await askGPT(choice.prompt);
          speak(reply);
          return showMenu();
        }

        switch (choice.state) {
          case "getName":
            speak("What is your name?");
            return listen("getName");
          case "getMood":
            speak("How are you feeling today?");
            return listen("getMood");
          case "mathTrick":
            return await mathTrick();
          case "chat":
            speak("Ask anything. You have 5 questions.");
            return listen("chat");
          case "exit":
            speak("Goodbye. Restarting in 5 seconds...");
            return setTimeout(start, 5000);
        }
      }

      if (state === "getName") {
        speak(`Nice to meet you, ${input}!`);
        return showMenu();
      }

      if (state === "getMood") {
        speak("Thanks for sharing how you feel.");
        return showMenu();
      }

      if (state === "chat") {
        chatMessages.push({ role: "user", content: input });
        const reply = await askGPT(input);
        chatMessages.push({ role: "assistant", content: reply });
        speak(reply);
        chatCount++;
        if (chatCount >= 5) {
          speak("You’ve reached your 5-question limit.");
          return showMenu();
        } else {
          return listen("chat");
        }
      }
    }

    async function askGPT(prompt) {
      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: [{ role: "user", content: prompt }] })
        });
        const data = await res.json();
        return data.reply || "Sorry, I didn’t get a response.";
      } catch (err) {
        return "Error: could not reach the assistant.";
      }
    }

    async function mathTrick() {
      speak("Let's do a fun mind trick.");
      await delay(1000);
      speak("Think of a number.");
      await delay(1300);
      speak("Double it.");
      await delay(1300);
      speak("Add 10.");
      await delay(1300);
      speak("Divide by 2.");
      await delay(1300);
      speak("Subtract your original number.");
      await delay(1300);
      speak("The answer is... 5! 😄");
      showMenu();
    }

    function delay(ms) {
      return new Promise(res => setTimeout(res, ms));
    }
  </script>
</body>
</html>

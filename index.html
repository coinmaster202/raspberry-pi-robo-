<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secure Motion Assistant</title>
  <style>
    body {
      background: #000;
      color: lime;
      font-family: monospace;
      padding: 20px;
    }
    #console {
      background: #111;
      padding: 15px;
      min-height: 300px;
      border-radius: 10px;
      white-space: pre-wrap;
      overflow-y: auto;
    }
    input, button {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 999;
      color: white;
      text-align: center;
      padding-top: 100px;
    }
    #overlay-content {
      display: inline-block;
      background: #300;
      border: 2px solid red;
      padding: 30px;
      border-radius: 15px;
      font-size: 18px;
    }
    #overlay input {
      padding: 8px;
      margin-top: 10px;
      width: 200px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>üîê Secure Motion Assistant</h1>
  <button onclick="startInteraction()">üëã Simulate Motion Detected</button>
  <div id="console"></div>

  <div id="input-area" style="display:none;">
    <input id="user-input" placeholder="Type your response..." onkeydown="if(event.key==='Enter'){handleInput()}" />
    <button onclick="handleInput()">Submit</button>
  </div>

  <div id="overlay">
    <div id="overlay-content">
      <h2>üö® Terminal Locked</h2>
      <p>This message has been flagged as inappropriate and blocked!</p>
      <p>Access has been restricted. Please contact support to unlock this terminal.</p>
      <p>Enter unlock code to continue:</p>
      <input id="unlock-code" type="text" placeholder="Enter code here" onkeydown="if(event.key==='Enter'){submitUnlock()}" />
      <br>
      <button onclick="submitUnlock()">Unlock</button>
    </div>
    <audio id="siren" src="https://www.soundjay.com/misc/sounds/siren-noise-01.mp3" autoplay loop></audio>
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  FRONT-END LOGIC (index.html)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const consoleEl = document.getElementById('console');
    const inputArea = document.getElementById('input-area');
    const userInput = document.getElementById('user-input');
    const overlay = document.getElementById('overlay');
    const unlockInput = document.getElementById('unlock-code');

    const optionMap = {
      "1": "1. What is your name?",
      "2": "2. How are you?",
      "3": "3. Try a math trick",
      "4": "4. Ask anything (ChatGPT mode)",
      "5": "5. Tell me a joke",
      "6": "6. Fun fact of the day",
      "7": "7. Guess my age",
      "8": "8. Compliment me",
      "9": "9. Surprise me",
      "10": "10. Exit"
    };
    const displayOrder = Object.keys(optionMap);
    const UNLOCK_CODE = "2026";

    let currentState = null;
    let asked = new Set();
    let locked = false;
    let chatCount = 0;

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function speak(text) {
      consoleEl.innerHTML += `ü§ñ: ${text}\n`;
      consoleEl.scrollTop = consoleEl.scrollHeight;
      return new Promise(resolve => {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = "en-US";
        msg.rate = 1;
        msg.onend = resolve;
        speechSynthesis.speak(msg);
      });
    }

    function listen(state) {
      currentState = state;
      inputArea.style.display = 'block';
      userInput.value = '';
      userInput.focus();
    }

    function submitUnlock() {
      if (unlockInput.value.trim() === UNLOCK_CODE) {
        overlay.style.display = "none";
        locked = false;
        speak("‚úÖ Terminal access restored.");
        startInteraction();
      } else {
        speak("‚ùå Invalid code.");
      }
    }

    // Entry point
    async function startInteraction() {
      if (locked) return;
      consoleEl.innerHTML = '';
      asked.clear();
      chatCount = 0;
      await speak("Hello, I see someone just arrived.");
      await delay(500);
      await speak("Welcome to my interactive assistant.");
      await delay(500);
      showMenu();
    }

    // Show menu options
    async function showMenu() {
      const remaining = displayOrder.filter(opt => !asked.has(opt));
      if (remaining.length === 0) {
        await speak("You've completed all options. Restarting soon.");
        return setTimeout(startInteraction, 3000);
      }
      await speak("Please choose one of the following options:");
      for (let opt of remaining) {
        await speak(optionMap[opt]);
        await delay(200);
      }
      listen("menu");
    }

    // Handle input in all states
    async function handleInput() {
      const raw = userInput.value.trim();
      const input = raw.toLowerCase();
      consoleEl.innerHTML += `You: ${raw}\n`;
      inputArea.style.display = "none";

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 1) MENU SELECTION (no moderation)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if (currentState === "menu") {
        if (!optionMap[input] || asked.has(input)) {
          await speak("That option is not available.");
          return showMenu();
        }
        asked.add(input);
        switch (input) {
          case "1":
            await speak("What is your name?");
            listen("getName");
            break;
          case "2":
            await speak("How are you feeling today?");
            listen("getMood");
            break;
          case "3":
            await mathTrick();
            showMenu();
            break;
          case "4":
            chatCount = 0;
            await speak("Ask anything. You have 5 questions.");
            listen("chat");
            break;
          case "5":
            await tellJoke();
            showMenu();
            break;
          case "6":
            await tellFact();
            showMenu();
            break;
          case "7":
            await speak("Do you like TikTok?");
            listen("guessAge");
            break;
          case "8":
            await compliment();
            showMenu();
            break;
          case "9":
            await speak("üéâ Surprise! You're amazing. Keep shining!");
            showMenu();
            break;
          case "10":
            await speak("Goodbye! Restarting soon...");
            setTimeout(startInteraction, 3000);
            break;
        }
        return;
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 2) NAME, MOOD, GUESS AGE, etc. (no moderation for these)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if (currentState === "getName") {
        await speak(`Nice to meet you, ${raw}`);
        return showMenu();
      }
      if (currentState === "getMood") {
        await speak("Thanks for sharing.");
        return showMenu();
      }
      if (currentState === "guessAge") {
        await speak(raw.includes("yes") ? "Hmm... I‚Äôd guess you‚Äôre under 25!" : "You seem mature. Maybe 30+?");
        return showMenu();
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 3) CHATGPT MODE (we run moderation here ONLY)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if (currentState === "chat") {
        chatCount++;
        if (chatCount > 5) {
          await speak("You've used all your questions. Returning to menu.");
          return showMenu();
        }

        // 3a) Check profanity/‚Äôflagged‚Äô only for chat inputs
        let flagged = false;
        try {
          const modRes = await fetch('/api/moderate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: raw })
          });
          const modJson = await modRes.json();
          flagged = modJson.flagged;
        } catch {
          // If moderation fails entirely, we block to be safe.
          flagged = true;
        }

        if (flagged) {
          locked = true;
          overlay.style.display = "block";
          await speak("‚ö†Ô∏è This message was flagged and blocked.");
          return;
        }

        // 3b) If not flagged, call /api/chat
        const messages = [
          { role: "system", content: "You are a helpful assistant." },
          { role: "user", content: raw }
        ];

        try {
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messages })
          });

          if (res.status === 403) {
            // If the server‚Äêside moderation also flags it, lock the UI
            locked = true;
            overlay.style.display = "block";
            await speak("‚ö†Ô∏è Your last message was blocked due to policy violation.");
            return;
          }

          const data = await res.json();
          if (res.status !== 200 || !data.reply) {
            throw new Error("Invalid response from chat endpoint");
          }

          await speak(data.reply);
        } catch (e) {
          console.error("Chat fetch error:", e);
          await speak("Sorry, there was an error.");
        }

        if (!locked && chatCount < 5) {
          listen("chat");
        } else if (chatCount >= 5) {
          await speak("You've reached 5 questions. Returning to menu shortly.");
          showMenu();
        }
        return;
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 4) FALLBACK (shouldn‚Äôt happen‚Äîbut just in case)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      await speak("I didn't understand that. Returning to menu.");
      return showMenu();
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  OTHER UTILITY FUNCTIONS (unchanged from before)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async function mathTrick() {
      await speak("Think of any number.");
      await delay(1200);
      await speak("Double it.");
      await delay(1200);
      await speak("Add 10.");
      await delay(1200);
      await speak("Divide by 2.");
      await delay(1200);
      await speak("Subtract your original number.");
      await delay(1500);
      await speak("The answer is... 5!");
    }

    async function tellJoke() {
      const jokes = [
        "Why did the computer go to therapy? It had too many bytes.",
        "Parallel lines have so much in common... it's a shame they'll never meet.",
        "Why don't robots panic? They have nerves of steel."
      ];
      await speak(jokes[Math.floor(Math.random() * jokes.length)]);
    }

    async function tellFact() {
      const facts = [
        "Octopuses have three hearts.",
        "Bananas are berries, but strawberries are not.",
        "A bolt of lightning contains enough energy to toast 100,000 slices of bread."
      ];
      await speak(facts[Math.floor(Math.random() * facts.length)]);
    }

    async function compliment() {
      const compliments = [
        "You're awesome just the way you are.",
        "If I had eyes, I‚Äôd say you look amazing today!",
        "Your mind is sharper than my processor!"
      ];
      await speak(compliments[Math.floor(Math.random() * compliments.length)]);
    }

    window.startInteraction = startInteraction;
    window.handleInput = handleInput;
    window.submitUnlock = submitUnlock;
  </script>
</body>
</html>
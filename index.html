<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üîê Secure Motion Assistant (with OpenAI Filter)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #0f0;
      padding: 20px;
    }
    #console {
      white-space: pre-wrap;
      background: #000;
      padding: 15px;
      border-radius: 10px;
      min-height: 300px;
      font-size: 16px;
      overflow-y: auto;
    }
    input, button {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 9999;
      text-align: center;
      color: red;
      padding-top: 20%;
      font-size: 24px;
    }
  </style>
</head>
<body>
  <h1>üîê Secure Motion Assistant</h1>
  <button onclick="startInteraction()">üëã Simulate Motion Detected</button>
  <div id="console"></div>
  <div id="input-area" style="display:none;">
    <input id="user-input" type="text" placeholder="Type your response...">
    <button onclick="handleInput()">Submit</button>
  </div>
  <div id="overlay">üö® Terminal Locked üö®<br>Awaiting authorized member to unlock with code 2026.</div>
  <audio id="siren" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
  <a id="log-download" style="display:none;"></a>

  <script>
    const consoleEl = document.getElementById('console');
    const inputArea = document.getElementById('input-area');
    const userInput = document.getElementById('user-input');
    const overlay = document.getElementById('overlay');
    const logDownload = document.getElementById('log-download');
    const siren = document.getElementById('siren');

    let currentState = null;
    let asked = new Set();
    let locked = false;
    let logEntry = "";
    const UNLOCK_CODE = "2026";

    async function speak(text) {
      consoleEl.innerHTML += `ü§ñ: ${text}\n`;
      const utterance = new SpeechSynthesisUtterance(text);
      speechSynthesis.speak(utterance);
      consoleEl.scrollTop = consoleEl.scrollHeight;
      return new Promise(res => setTimeout(res, 1500));
    }

    function listen(state) {
      currentState = state;
      if (!locked) {
        inputArea.style.display = 'block';
        userInput.value = '';
        userInput.focus();
      }
    }

    async function startInteraction() {
      if (locked) return;
      asked.clear();
      consoleEl.innerHTML = '';
      await speak("Hello! I see someone just arrived.");
      await speak("Welcome to my interactive assistant.");
      showMenu();
    }

    async function showMenu() {
      const options = ["1. What is your name?", "2. How are you?", "3. Try a math trick", "4. Exit"];
      const available = options.filter((_, i) => !asked.has((i+1).toString()));
      if (available.length === 0) {
        await speak("You've completed all options. Restarting...");
        setTimeout(startInteraction, 5000);
        return;
      }
      await speak("Please choose one:");
      for (let option of available) await speak(option);
      listen("menu");
    }

    async function handleInput() {
      const rawInput = userInput.value.trim();
      const input = rawInput.toLowerCase();
      inputArea.style.display = 'none';

      consoleEl.innerHTML += `You: ${rawInput}\n`;
      await speak("Checking input...");
      if (await openAIModerationCheck(rawInput)) {
        await triggerLockdown(rawInput);
        return;
      }

      if (locked) {
        if (currentState === "unlock" && input === UNLOCK_CODE) {
          locked = false;
          overlay.style.display = "none";
          logDownload.style.display = "none";
          await speak("‚úÖ Terminal unlocked.");
          return startInteraction();
        } else {
          await speak("‚ùå Invalid unlock code.");
          return listen("unlock");
        }
      }

      switch (currentState) {
        case "menu":
          if (input === "1") {
            asked.add("1"); await speak("What is your name?"); listen("name");
          } else if (input === "2") {
            asked.add("2"); await speak("How are you feeling today?"); listen("mood");
          } else if (input === "3") {
            asked.add("3"); await mathTrick(); showMenu();
          } else if (input === "4") {
            asked.add("4"); await speak("Goodbye! Restarting soon..."); setTimeout(startInteraction, 5000);
          } else {
            await speak("Invalid choice."); showMenu();
          }
          break;

        case "name":
          await speak(`Nice to meet you, ${rawInput || 'friend'}!`);
          showMenu();
          break;

        case "mood":
          await speak("Thanks for sharing that with me.");
          showMenu();
          break;
      }
    }

    async function mathTrick() {
      await speak("Think of any number, don't tell me.");
      await speak("Now double it.");
      await speak("Add 10.");
      await speak("Divide by 2.");
      await speak("Now subtract the number you started with.");
      await speak("The answer is... 5! üòÑ");
    }

    async function triggerLockdown(input) {
      locked = true;
      overlay.style.display = "block";
      siren.play();
      logEntry = `üö® Blocked input: '${input}'\nTime: ${new Date().toLocaleString()}`;
      await speak("‚ö†Ô∏è This message has been flagged as inappropriate.");
      await speak("All further interaction has been blocked due to the use of an inappropriate word.");
      await speak("Please stand by and ask an authorized member to unlock the terminal.");
      downloadLog();
      listen("unlock");
    }

    function downloadLog() {
      const blob = new Blob([logEntry], { type: 'text/plain' });
      logDownload.href = URL.createObjectURL(blob);
      logDownload.download = "lockdown-log.txt";
      logDownload.style.display = 'inline';
      logDownload.textContent = "‚¨áÔ∏è Download Lockdown Log";
    }

    async function openAIModerationCheck(userInput) {
      try {
        const res = await fetch("/api/moderate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input: userInput })
        });
        const data = await res.json();
        return data.result === "blocked";
      } catch (err) {
        console.error("Moderation failed:", err);
        return false;
      }
    }
  </script>
</body>
</html>
